I"(<p>In some exploitation scenarios such as local privilege escalation, command execution, write privilege attacks, SQL Injections, etc, it is very likely that you have to upload one or more malicious files in order to gain control of the target machine. Well, a smart attacker shouldn’t leave anything behind, so if a module needs to drop something onto the file system, it’s important to remove it right after the purpose is served. And that is why we created the FileDropper mixin.</p>

<h3 id="examples">Examples</h3>

<p>The FileDropper mixin is a file manager that allows you keep track of files, and then delete them when a session is created. To use it, first include the mixin like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">FileDropper</span>
</code></pre></div></div>

<p>Next, tell the FileDropper mixin where the file is going to be after a session is created by using the <code class="highlighter-rouge">register_file_for_cleanup</code> method. Each file name should either be a full path, or relative to the current working directory of the session. For example, if I want to upload a payload to the target machine’s remote path: <code class="highlighter-rouge">C:\Windows\System32\payload.exe</code>, then my statement can be:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">register_file_for_cleanup</span><span class="p">(</span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">System32</span><span class="se">\\</span><span class="s2">payload.exe"</span><span class="p">)</span>
</code></pre></div></div>

<p>If my session’s current directory is already in <code class="highlighter-rouge">C:\Windows\System32\</code>, then I can simply do:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">register_file_for_cleanup</span><span class="p">(</span><span class="s2">"payload.exe"</span><span class="p">)</span>
</code></pre></div></div>

<p>If you wish to register multiple files, you can also provide the file names as arguments:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">register_file_for_cleanup</span><span class="p">(</span><span class="s2">"file_1.vbs"</span><span class="p">,</span> <span class="s2">"file_2.exe"</span><span class="p">,</span> <span class="s2">"file_1.conf"</span><span class="p">)</span>
</code></pre></div></div>

<p>Note that if your exploit module uses <code class="highlighter-rouge">on_new_session</code>, you are actually overriding FileDropper’s <code class="highlighter-rouge">on_new_session</code>.</p>

<h3 id="reference">Reference</h3>

<p>https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/file_dropper.rb</p>
:ET