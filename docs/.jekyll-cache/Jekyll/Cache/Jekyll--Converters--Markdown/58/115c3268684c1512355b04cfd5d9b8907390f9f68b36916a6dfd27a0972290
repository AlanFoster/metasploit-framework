I"N0<h1 id="work-needed-to-allow-msfdb-to-use-postgresql-common">Work needed to allow msfdb to use postgresql-common</h1>

<p>Linux distributions, such as Debian and Kali Linux, use <a href="https://salsa.debian.org/postgresql/postgresql-common">postgresql-common (Multi-Version/Multi-Cluster PostgreSQL architecture)</a> wrappers to interact with one or more PostgreSQL installations. Therefore, commands such as <code class="highlighter-rouge">initdb</code> and <code class="highlighter-rouge">pg_ctl</code> are not in the user’s <code class="highlighter-rouge">PATH</code>. <code class="highlighter-rouge">msfdb</code> currently assumes these programs are available in the <code class="highlighter-rouge">PATH</code>. In order to support platforms that use the <code class="highlighter-rouge">postgresql-common</code> wrappers, <code class="highlighter-rouge">msfdb</code> would need to determine if it is running on such a platform and modify the commands used to perform the various setup and configuration operations. See the section “msfdb support for postgresql-common” for additional details.</p>

<h2 id="msfdb-support-for-postgresql-common"><code class="highlighter-rouge">msfdb</code> support for postgresql-common</h2>

<h3 id="requirements">Requirements</h3>

<ul>
  <li>Determine if the system is using <code class="highlighter-rouge">postgresql-common</code>.</li>
  <li>Ideally, allow a user without elevated privileges to setup a database for use with Metasploit.</li>
  <li>Determine the current version of PostgreSQL on the system when multiple versions might be installed in parallel.</li>
  <li>
    <p>The port number used for the server when <code class="highlighter-rouge">pg_createcluster</code> is run without a port number option defaults to the “next free port starting from 5432”. If we don’t specify the port number when calling <code class="highlighter-rouge">pg_createcluster</code> we can scrape the port number from the <code class="highlighter-rouge">pg_lsclusters</code> output.</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters --no-header | awk '/^9.6/ { if ($2 == "msf") { print $3; } }'
  5433
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="notes">Notes</h3>

<p>Debian’s <a href="https://salsa.debian.org/postgresql/postgresql-common">postgresql-common (Multi-Version/Multi-Cluster PostgreSQL architecture)</a> contains PostgreSQL wrapper tools:</p>

<ul>
  <li><code class="highlighter-rouge">pg_lsclusters</code>: list all available clusters with their status and configuration</li>
  <li><code class="highlighter-rouge">pg_createcluster</code>: wrapper for <code class="highlighter-rouge">initdb</code>, sets up the necessary configuration structure
    <ul>
      <li><code class="highlighter-rouge">pg_createcluster [options] version name [-- initdb options]</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">pg_ctlcluster</code>: wrapper for <code class="highlighter-rouge">pg_ctl</code>, control the cluster postgres server
    <ul>
      <li>pg_ctlcluster [options] cluster-version cluster-name action – [pg_ctl options]</li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>where action = start</td>
              <td>stop</td>
              <td>restart</td>
              <td>reload</td>
              <td>promote</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">pg_dropcluster</code>: remove a cluster and its configuration
    <ul>
      <li>pg_dropcluster [–stop] cluster-version cluster-name</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">pg_wrapper</code>: wrapper for PostgreSQL client commands
    <ul>
      <li>client-program [–cluster version/cluster] […]</li>
      <li>( client-program: psql, createdb, dropuser, and all other client programs installed in /usr/lib/postgresql/ version/bin).</li>
    </ul>
  </li>
</ul>

<p>The “database cluster” simply refers to a set of databases on a single server rather than a group of multiple database servers.</p>

<h3 id="manually-create-and-initialize-msf-database-using-postgresql-common">Manually create and initialize MSF database using postgresql-common</h3>

<h4 id="issues">Issues</h4>

<p>Encountered permissions issues when attempting to create a cluster.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pg_createcluster --user=$(whoami) --encoding=UTF8 9.6 msf -- --username=$(whoami) --auth-host=trust --auth-local=trust
install: cannot change permissions of ‘/etc/postgresql/9.6/msf’: No such file or directory
Error: could not create configuration directory; you might need to run this program with root privileges
</code></pre></div></div>

<p>Requiring root privileges may be prohibitive to user installs of MSF. How can we create a cluster without root privileges? Adding the user to the postgres group and attempting to <code class="highlighter-rouge">sudo -u postgres</code> the command, however, resulted in the same error message. Looking closer at the various commands and discovered the following in the man page for <code class="highlighter-rouge">pg_wrapper</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT
    This specifies an alternative base directory for cluster configurations. This is usually
    /etc/postgresql/, but for testing/development purposes you can change this to point to e. g. your
    home directory, so that you can use the postgresql-common tools without root privileges.
</code></pre></div></div>

<h4 id="working-solution">Working Solution</h4>

<ul>
  <li>Create cluster (“initdb”) to set up the necessary configuration structure:</li>
</ul>

<p>Note, running <code class="highlighter-rouge">mkdir -p $HOME/.local/etc/postgresql;</code> before the <code class="highlighter-rouge">pg_createcluster</code> command didn’t stop the “install: cannot change owner and permissions of ‘/home/msfdev/.local/etc/postgresql/9.6’: Operation not permitted” message from appearing. This appears to be a warning only and doesn’t seem to affect cluster creation.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p $HOME/.local/var/log/postgresql; PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_createcluster --user=$(whoami) --datadir=$HOME/msf-db-datadir --socketdir=$HOME/.local/var/run/postgresql --logfile=$HOME/.local/var/log/postgresql/postgresql-version-msf.log --encoding=UTF8 9.6 msf -- --username=$(whoami) --auth-host=trust --auth-local=trust
install: cannot change owner and permissions of ‘/home/msfdev/.local/etc/postgresql/9.6’: Operation not permitted
Creating new cluster 9.6/msf ...
config /home/msfdev/.local/etc/postgresql/9.6/msf
data /home/msfdev/msf-db-datadir
locale en_US.UTF-8
socket /home/msfdev/.local/var/run/postgresql
port 5433
</code></pre></div></div>

<ul>
  <li>Check cluster was successfully created and appears in the list of all available clusters:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters
Ver Cluster Port Status Owner Data directory Log file
9.6 msf 5433 down msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log
</code></pre></div></div>

<ul>
  <li>Start postmaster server for the cluster (“pg_ctl”):</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf start
</code></pre></div></div>

<ul>
  <li>Check that the cluster was successfully started:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters
Ver Cluster Port Status Owner Data directory Log file
9.6 msf 5433 online msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log
</code></pre></div></div>

<ul>
  <li>Perform <code class="highlighter-rouge">msfdb</code>’s <code class="highlighter-rouge">write_db_config</code> method work by manually creating the <code class="highlighter-rouge">~/.msf4/database.yml</code> file.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>development: &amp;pgsql
  adapter: postgresql
  database: msf
  username: msf
  password: Password123
  host: 127.0.0.1
  port: 5433
  pool: 200

production: &amp;production
  &lt;&lt;: *pgsql

test:
  &lt;&lt;: *pgsql
  database: msftest
  username: msftest
  password: Password123
</code></pre></div></div>

<ul>
  <li>Create database users:</li>
</ul>

<p>Note, these steps are from <code class="highlighter-rouge">msfdb</code>’s <code class="highlighter-rouge">init_db</code> method. The following example only creates the main MSF user account and not the test account.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c "create user msf with password 'Password123';" postgres
CREATE ROLE
PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c "alter role msf createdb;" postgres
ALTER ROLE
PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql psql --cluster 9.6/msf -c "alter role msf with password 'Password123';" postgres
ALTER ROLE
PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql createdb --cluster 9.6/msf -O msf -h 127.0.0.1 -U msf -E UTF-8 -T template0 msf
</code></pre></div></div>

<ul>
  <li>
    <p>Perform <code class="highlighter-rouge">msfdb</code>’s <code class="highlighter-rouge">write_db_client_auth_config</code> method work, except it needs to write the <code class="highlighter-rouge">pg_hba.conf</code> file now stored in under <code class="highlighter-rouge">PG_CLUSTER_CONF_ROOT</code> and inside the <code class="highlighter-rouge">version/cluster-name</code> directory. In this example that location is: <code class="highlighter-rouge">$HOME/.local/etc/postgresql/9.6/msf/pg_hba.conf</code>.</p>
  </li>
  <li>
    <p>Perform <code class="highlighter-rouge">msfdb</code>’s <code class="highlighter-rouge">restart_db</code> method work, by stopping and then starting the server. Stop and then start postmaster server for the cluster (“pg_ctl”):</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf stop
PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_ctlcluster 9.6 msf start
</code></pre></div></div>

<ul>
  <li>Check that the cluster was successfully started:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_lsclusters
Ver Cluster Port Status Owner Data directory Log file
9.6 msf 5433 online msfdev /home/msfdev/msf-db-datadir /home/msfdev/.local/var/log/postgresql/postgresql-version-msf.log
</code></pre></div></div>

<ul>
  <li>Create initial database schema:</li>
</ul>

<p>Note, these steps are from <code class="highlighter-rouge">msfdb</code>’s <code class="highlighter-rouge">init_db</code> method.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~/metasploit-framework
bundle exec rake db:migrate
</code></pre></div></div>

<ul>
  <li>Start <code class="highlighter-rouge">msfconsole</code> and verify postgresql connection using the <code class="highlighter-rouge">db_status</code> command:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># disable or remove ~/.msf4/config if it is configured to auto connect to a data service
mv ~/.msf4/config ~/.msf4/config.disable
./msfconsole
...
msf5 &gt; db_status 
[*] Connected to msf. Connection type: postgresql.
</code></pre></div></div>

<ul>
  <li>Drop (delete) the cluster:</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PG_CLUSTER_CONF_ROOT=$HOME/.local/etc/postgresql pg_dropcluster 9.6 msf
</code></pre></div></div>
:ET