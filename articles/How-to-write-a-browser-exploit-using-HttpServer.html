<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Git Reference Sites | Metasploit spike</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Git Reference Sites" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learning Git" />
<meta property="og:description" content="Learning Git" />
<link rel="canonical" href="/metasploit-framework/articles/Git-Reference-Sites.html" />
<meta property="og:url" content="/metasploit-framework/articles/Git-Reference-Sites.html" />
<meta property="og:site_name" content="Metasploit spike" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-01-12T17:14:28+00:00" />
<script type="application/ld+json">
{"description":"Learning Git","headline":"Git Reference Sites","dateModified":"2012-01-12T17:14:28+00:00","datePublished":"2012-01-12T17:14:28+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/metasploit-framework/articles/Git-Reference-Sites.html"},"url":"/metasploit-framework/articles/Git-Reference-Sites.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/metasploit-framework/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/metasploit-framework/feed.xml" title="Metasploit spike" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/metasploit-framework/">Metasploit spike</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
            <a class="page-link" href="/metasploit-framework/">Articles</a><a class="page-link" href="/metasploit-framework/modules/">Modules</a></div>
        </nav></div>
  </header>
  <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to write a browser exploit using HttpServer</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-03-14T15:17:49+00:00" itemprop="datePublished">Mar 14, 2016
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The Metasploit Framework provides different mixins you can use to develop a browser exploit, mainly they are <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-write-a-browser-exploit-using-HttpServer">Msf::Exploit::Remote::HttpServer</a>, Msf::Exploit::Remote::HttpServer::HTML and <a href="https://github.com/rapid7/metasploit-framework/wiki/How-to-write-a-browser-exploit-using-BrowserExploitServer">Msf::Exploit::Remote::BrowserExploitServer</a>. This writeup covers the HttpServer mixin.</p>

<p>The HttpServer mixin is kind of the mother of all HTTP server mixins (like BrowserExploitServer and HttpServer::HTML). To use it, your module is required to have a “on_request_uri” method, which is a callback triggered when the HTTP server receives a HTTP request from the browser. An example of setting up “on_request_uri”:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Listens for a HTTP request.</span>
<span class="c1"># cli is the socket object, and request is a Rex::Proto::Http::Request object</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">on_request_uri</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
	<span class="n">print_status</span><span class="p">(</span><span class="s2">"Client requests URI: </span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">uri</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The “on_request_uri” method is also where you can create the HTTP response. Here’s a couple of choices you can use to do that:</p>

<ul>
  <li><strong>send_not_found(cli)</strong> - Sends a 404 to the client. Make sure to pass the cli (socket) object.</li>
  <li><strong>send_redirect(cli, location=’/’, body=’’, headers={})</strong> - Redirects the client to a new location.</li>
  <li><strong>send_response(cli, body, headers={})</strong> - Sends a response to the client. This method is probably what you’ll be using most of the time.</li>
</ul>

<p>If you’ve seen some of our exploit modules, you will also see them using Exploit::Remote::HttpServer::HTML instead of Exploit::Remote::HttpServer. Usage is mostly the same, the difference is the Exploit::Remote::HttpServer::HTML mixin gives you access to some Javascript functions like Base64, heap spraying, OS detection, etc.</p>

<p>Here’s an example of sending a HTTP response:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># Sends a "Hello, world!" to the client</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">on_request_uri</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
	<span class="n">html</span> <span class="o">=</span> <span class="s2">"Hello, world!"</span>
	<span class="n">send_response</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Also note that in order to handle a HTTP request, it must contain the base URIPATH, which by default is random. This means if you want to handle multiple URIs (possible if you need to handle a redirect or a link), you also need to make sure they have the base URIPATH. To retrieve the base URIPATH, you can use the “get_resource” method, here’s an example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">serve_page_1</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="n">html</span> <span class="o">=</span> <span class="s2">"This is page 1"</span>
	<span class="n">send_response</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">serve_page_2</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="n">html</span> <span class="o">=</span> <span class="s2">"This is page 2"</span>
	<span class="n">send_response</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">serve_default_page</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="n">html</span> <span class="o">=</span> <span class="sx">%Q|
	&lt;html&gt;
	&lt;a href="</span><span class="si">#{</span><span class="n">get_resource</span><span class="p">.</span><span class="nf">chomp</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="sx">/page_1.html"&gt;Go to page 1&lt;/a&gt;&lt;br&gt;
	&lt;a href="</span><span class="si">#{</span><span class="n">get_resource</span><span class="p">.</span><span class="nf">chomp</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span><span class="si">}</span><span class="sx">/page_2.html"&gt;Go to page 2&lt;/a&gt;
	&lt;/html&gt;
	|</span>

	<span class="n">send_response</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">on_request_uri</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
	<span class="k">case</span> <span class="n">request</span><span class="p">.</span><span class="nf">uri</span>
	<span class="k">when</span> <span class="sr">/page_1\.html$/</span>
		<span class="n">serve_page_1</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="k">when</span> <span class="sr">/page_2\.html$/</span>
		<span class="n">serve_page_2</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="k">else</span>
		<span class="n">serve_default_page</span><span class="p">(</span><span class="n">cli</span><span class="p">)</span>
	<span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Of course, when you write a Metasploit browser exploit there’s a lot more you need to think about. For example, your module probably needs to do browser detection, because it wouldn’t make any sense to allow Chrome to receive an IE exploit, would it? You probably also need to build a payload that’s specific to the target, which means your module needs to know what target it’s hitting, and you have to build a method to customize the exploit accordingly, etc. The HttpServer and HttpServer::HTML mixin provies all kinds of methods to allow you to accomplish all these. Make sure to check out the API documentation (you can either do this by running msf/documentation/gendocs.sh, or just run “yard” in the msf directory), or checkout existing code examples (especially the recent ones).</p>

<p>To get things started, you can always use the following template to start developing your browser exploit:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">##</span>
<span class="c1"># This module requires Metasploit: http://metasploit.com/download</span>
<span class="c1"># Current source: https://github.com/rapid7/metasploit-framework</span>
<span class="c1">##</span>

<span class="nb">require</span> <span class="s1">'msf/core'</span>

<span class="k">class</span> <span class="nc">MetasploitModule</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
  <span class="no">Rank</span> <span class="o">=</span> <span class="no">NormalRanking</span>

  <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">HttpServer</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">super</span><span class="p">(</span><span class="n">update_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
      <span class="s1">'Name'</span>           <span class="o">=&gt;</span> <span class="s2">"HttpServer mixin example"</span><span class="p">,</span>
      <span class="s1">'Description'</span>    <span class="o">=&gt;</span> <span class="sx">%q{
        Here's an example of using the HttpServer mixin
      }</span><span class="p">,</span>
      <span class="s1">'License'</span>        <span class="o">=&gt;</span> <span class="no">MSF_LICENSE</span><span class="p">,</span>
      <span class="s1">'Author'</span>         <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'sinn3r'</span> <span class="p">],</span>
      <span class="s1">'References'</span>     <span class="o">=&gt;</span> 
        <span class="p">[</span>
          <span class="p">[</span> <span class="s1">'URL'</span><span class="p">,</span> <span class="s1">'http://metasploit.com'</span> <span class="p">]</span>
        <span class="p">],</span>
      <span class="s1">'Platform'</span>       <span class="o">=&gt;</span> <span class="s1">'win'</span><span class="p">,</span>
      <span class="s1">'Targets'</span>        <span class="o">=&gt;</span>
        <span class="p">[</span>
          <span class="p">[</span> <span class="s1">'Generic'</span><span class="p">,</span> <span class="p">{}</span> <span class="p">],</span>
        <span class="p">],</span>
      <span class="s1">'DisclosureDate'</span> <span class="o">=&gt;</span> <span class="s2">"Apr 1 2013"</span><span class="p">,</span>
      <span class="s1">'DefaultTarget'</span>  <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">on_request_uri</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="s2">"hello"</span>
    <span class="n">send_response</span><span class="p">(</span><span class="n">cli</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p>If you want to take a closer look at what the mixin can do, see:
https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/http/server.rb</p>

  </div><a class="u-url" href="/metasploit-framework/articles/How-to-write-a-browser-exploit-using-HttpServer.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/metasploit-framework/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Metasploit spike</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Metasploit spike</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/metasploit-framework/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/metasploit-framework/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
