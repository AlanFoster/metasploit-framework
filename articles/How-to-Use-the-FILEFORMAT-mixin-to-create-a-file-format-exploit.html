<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Git Reference Sites | Metasploit spike</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Git Reference Sites" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learning Git" />
<meta property="og:description" content="Learning Git" />
<link rel="canonical" href="/metasploit-framework/articles/Git-Reference-Sites.html" />
<meta property="og:url" content="/metasploit-framework/articles/Git-Reference-Sites.html" />
<meta property="og:site_name" content="Metasploit spike" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-01-12T17:14:28+00:00" />
<script type="application/ld+json">
{"description":"Learning Git","headline":"Git Reference Sites","dateModified":"2012-01-12T17:14:28+00:00","datePublished":"2012-01-12T17:14:28+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/metasploit-framework/articles/Git-Reference-Sites.html"},"url":"/metasploit-framework/articles/Git-Reference-Sites.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/metasploit-framework/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/metasploit-framework/feed.xml" title="Metasploit spike" /></head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/metasploit-framework/">Metasploit spike</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
            <a class="page-link" href="/metasploit-framework/">Articles</a><a class="page-link" href="/metasploit-framework/modules/">Modules</a></div>
        </nav></div>
  </header>
  <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">How to Use the FILEFORMAT mixin to create a file format exploit</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-08-11T01:00:52+01:00" itemprop="datePublished">Aug 11, 2014
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><code class="highlighter-rouge">Msf::Exploit::FILEFORMAT</code> is the mixin to use to create a file format exploit. There actually isn’t much in the mixin, but the most important method is this: <code class="highlighter-rouge">file_create</code>:</p>

<h3 id="usage-for-file_create">Usage for file_create</h3>

<p>As the name implies, the <code class="highlighter-rouge">file_create</code> method allows you to create a file. You should be using this method because it does more than just writing data to disk. One of the important things it does is it will report the file creation to the database in the format of <code class="highlighter-rouge">#{ltype}.localpath</code>, and the file will always be written to Metasploit’s local directory defined in <code class="highlighter-rouge">Msf::Config.local_directory</code> (by default this path is <code class="highlighter-rouge">~/.msf4/local</code>), which keep files nice and organized.</p>

<p>To use the mixin, first include <code class="highlighter-rouge">Msf::Exploit::FILEFORMAT</code> under the scope of your <code class="highlighter-rouge">Metasploit3</code> class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">FILEFORMAT</span>
</code></pre></div></div>

<p>And here’s an example of using <code class="highlighter-rouge">file_create</code> to build an imaginary exploit:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is my imaginary exploit</span>
<span class="n">buf</span> <span class="o">=</span> <span class="s2">""</span>
<span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="s2">"A"</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="mh">0x40201f01</span><span class="p">].</span><span class="nf">pack</span><span class="p">(</span><span class="s2">"V"</span><span class="p">)</span>
<span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\x90</span><span class="s2">"</span> <span class="o">*</span> <span class="mi">10</span>
<span class="n">buf</span> <span class="o">&lt;&lt;</span> <span class="n">payload</span><span class="p">.</span><span class="nf">encoded</span>

<span class="n">file_create</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="custom-filename">Custom filename</h3>

<p>The <code class="highlighter-rouge">Msf::Exploit::FILENAME</code> mixin by default has a registered <code class="highlighter-rouge">FILENAME</code> datastore option, and it is actually optional. If there’s no filename provided, the mixin will set the name in this format: <code class="highlighter-rouge">"exploit.fileformat.#{self.shortname}"</code>, where <code class="highlighter-rouge">self.shortname</code> means the shorter version of the module name.</p>

<p>If you wish to set a default one (but still changeable by the user), then you simply register it again in the module, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">register_options</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="no">OptString</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'FILENAME'</span><span class="p">,</span> <span class="p">[</span><span class="kp">true</span><span class="p">,</span> <span class="s1">'The malicious file name'</span><span class="p">,</span>  <span class="s1">'msf.jpg'</span><span class="p">])</span>
  <span class="p">],</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="fixed-filename">Fixed filename</h3>

<p>Occasionally, you might not want your user to change the filename at all. A lazy trick to do that is by modifying the <code class="highlighter-rouge">FILENAME</code> datastore option at runtime, but this is very much not recommended. In fact, if you do this, you will not pass <a href="https://github.com/rapid7/metasploit-framework/wiki/Guidelines-for-Accepting-Modules-and-Enhancements#module-additions">msftidy</a>. Instead, here’s how it’s done properly:</p>

<p>1 - Deregister the <code class="highlighter-rouge">FILENAME</code> option</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">deregister_options</span><span class="p">(</span><span class="s1">'FILENAME'</span><span class="p">)</span>
</code></pre></div></div>

<p>2 - Next, override the <code class="highlighter-rouge">file_format_filename</code> method, and make it return the filename you want:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">file_format_filename</span>
  <span class="s1">'something.jpg'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>3 - Finally, please leave a note about this in the module description.</p>

<h3 id="references">References</h3>

<p>https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/fileformat.rb</p>

<p>https://github.com/rapid7/metasploit-framework/tree/master/modules/exploits/windows/local</p>

  </div><a class="u-url" href="/metasploit-framework/articles/How-to-Use-the-FILEFORMAT-mixin-to-create-a-file-format-exploit.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/metasploit-framework/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Metasploit spike</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Metasploit spike</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/metasploit-framework/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/metasploit-framework/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
